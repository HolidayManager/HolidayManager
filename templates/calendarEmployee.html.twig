{% block stylesheets %}
{#{% parent() %}#}
<link rel="stylesheet" href="/css/calendar.css">
{% endblock %}

{% block body %}

  <!--
    <div class='demo-topbar'>
        Timeline view resource grouping
    </div>
-->
    {% include 'searchBar.html.twig' %}
    <div id='calendar'></div>

        <script>

            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    plugins: ['resourceTimeline'],
                    header: {
                        left: 'today prev,next',
                        center: 'title',
                        right: 'resourceTimelineWeek,resourceTimelineMonth'
                    },
                    aspectRatio: 1.6,
                    defaultView: 'resourceTimelineMonth',
                    resourceGroupField: 'building',
                    schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                    resources: '/calendar/show/users',
                    events: 'calendar/show/holidays', /* link to the events api php located in apiHolidays.php*/


                });



                calendar.render();

                    $("form").on("submit", search);

                    function search(e) {
                        e.preventDefault();

                        let department = $("#search_user_list_form_department").val();
                        let role = $("#search_user_list_form_roles").val();
                        let firstname = $("#search_user_list_form_firstname").val();
                        let lastname = $("#search_user_list_form_lastname").val();

                        let startDate = calendar.view.currentStart;
                        let endDate = calendar.view.currentEnd;

                        console.log("startdate: " + startDate);
                        console.log("enddate: " + endDate);

                        $.ajax({
                            url: '/search/users',
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                startDate: format(startDate),
                                endDate:  format(endDate),
                                department: department,
                                role: role,
                                firstname: firstname,
                                lastname: lastname
                            },
                            success: function(data) {

                                calendar.removeAllEvents();
                                calendar.removeAllEventSources();

                                calendar.addEventSource(data[0].holidays);



                                let resources = calendar.getResources();

                                for(let i =0;i<resources.length;i++)
                                {
                                    resource = resources[i];
                                    resource.remove();
                                }

                                for(let i =0;i<data[0].users.length;i++)
                                {
                                    console.log(data[0].users[i]);
                                   calendar.addResource({
                                        'title' : data[0].users[i].title,
                                        'id'    :   data[0].users[i].id,
                                        'building' :  data[0].users[i].building
                                    });
                                }


                                calendar.rerenderResources();



                                $('#resultSearch').text(data[0].count_result + "Result found in the database.");
                            }
                        });
                    };
                    function format(date){
                        let dd = date.getDate();
                        let mm = date.getMonth()+1;
                        let yyyy = date.getFullYear();

                        if(dd<10)
                        {
                            dd='0'+dd;
                        }

                        if(mm<10)
                        {
                            mm='0'+mm;
                        }
                        return dd+"-"+mm+"-"+yyyy;
                    }

            });
                </script>
{% endblock %}

